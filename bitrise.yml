---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: flutter

triggers:
  push:
  - branch: main
    workflow: android_firebase
  pull_request:
  - source_branch: "*"
    workflow: android_firebase

app:
  envs:
  - BITRISE_FLUTTER_PROJECT_LOCATION: "."
    opts:
      is_expand: false
  - BITRISE_PROJECT_PATH: android/build.gradle.kts
    opts:
      is_expand: false
workflows:
  android_firebase:
    description: Build Android APK for Tracker Costs with Firebase App Distribution
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@8: {}
    - flutter-installer@0:
        inputs:
        - version: 3.38.4
        - is_update: 'false'
    - restore-dart-cache@2: {}
    - script@1:
        title: Flutter packages get
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            echo "Installing Flutter dependencies..."
            flutter pub get
            echo "Dependencies installed"
    - script@1:
        title: Flutter analyze
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            echo "Running Flutter analyze..."
            flutter analyze || true
        is_always_run: false
    - script@1:
        title: Run Flutter tests
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            echo "Running tests..."
            flutter test || echo "WARNING: No tests found or tests failed"
        is_always_run: false
    - save-dart-cache@1: {}
    - script@1:
        title: Setup Firebase Configuration
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            echo "Setting up Firebase configuration..."

            # If google-services.json is base64 encoded in Secrets
            if [ ! -z "$GOOGLE_SERVICES_JSON_BASE64" ]; then
              echo "Decoding google-services.json from Secrets..."
              echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 -d > android/app/google-services.json
              echo "SUCCESS: google-services.json created from Secrets"
            else
              echo "WARNING: Using google-services.json from repository"
            fi

            # Verify file exists
            if [ -f "android/app/google-services.json" ]; then
              echo "SUCCESS: google-services.json found"
            else
              echo "ERROR: google-services.json NOT found!"
              exit 1
            fi
        is_always_run: true
    - script@1:
        title: Setup Android Keystore
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            echo "Setting up Android keystore for signing..."

            # Validate environment variables
            if [ -z "$ANDROID_KEYSTORE_BASE64" ]; then
              echo "ERROR: ANDROID_KEYSTORE_BASE64 not found in Secrets!"
              exit 1
            fi

            if [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_PASSWORD" ] || [ -z "$KEY_ALIAS" ]; then
              echo "ERROR: Keystore credentials not found!"
              echo "Missing: KEYSTORE_PASSWORD, KEY_PASSWORD, or KEY_ALIAS"
              exit 1
            fi

            # Create keystore directory
            mkdir -p android/app

            # Decode keystore from base64 (Linux-compatible)
            echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks

            # Verify keystore file
            if [ -f "android/app/upload-keystore.jks" ]; then
              KEYSTORE_SIZE=$(du -h android/app/upload-keystore.jks | cut -f1)
              echo "SUCCESS: Keystore created ($KEYSTORE_SIZE)"
            else
              echo "ERROR: Keystore file not created!"
              exit 1
            fi

            # Create key.properties file
            cat > android/key.properties <<EOF
            storePassword=${KEYSTORE_PASSWORD}
            keyPassword=${KEY_PASSWORD}
            keyAlias=${KEY_ALIAS}
            storeFile=upload-keystore.jks
            EOF

            # Verify key.properties
            if [ -f "android/key.properties" ]; then
              echo "SUCCESS: key.properties created"
              echo "Configuration:"
              echo "  - Alias: ${KEY_ALIAS}"
              echo "  - Keystore: upload-keystore.jks"
              echo "  - SHA-1: 13:75:AE:52:C9:70:08:6E:88:7F:D0:84:68:7C:6B:DD:78:EB:6E:EF"
            else
              echo "ERROR: key.properties not created!"
              exit 1
            fi
        is_always_run: true
    - script@1:
        title: Build Android APK (Release)
        inputs:
        - content: "#!/usr/bin/env bash

            set -e

            echo \"Building Tracker Costs Android APK in RELEASE mode...\"


            flutter build apk --release --no-tree-shake-icons


            APK_PATH=\"build/app/outputs/flutter-apk/app-release.apk\"


            if [ -f \"$APK_PATH\" ]; then

            \  echo \"SUCCESS: APK built successfully!\"

            \  echo \"APK info:\"

            \  ls -lh \"$APK_PATH\"

            \ \ 

            \  # Get APK size

            \  APK_SIZE=$(du -h \"$APK_PATH\" | cut -f1)

            \  echo \"Size: $APK_SIZE\"

            \ \ 

            \  # Export for Firebase

            \  envman add --key ANDROID_APK_PATH --value
            \"$BITRISE_SOURCE_DIR/$APK_PATH\"

            \ \ 

            \  # Copy to deploy dir with version

            \ 
            BUILD_NAME=\"TrackerCosts_v1.0.0_build${BITRISE_BUILD_NUMBER}.apk\"

            \  cp \"$APK_PATH\" \"$BITRISE_DEPLOY_DIR/$BUILD_NAME\"

            \  echo \"APK copied to artifacts as: $BUILD_NAME\"

            else

            \  echo \"ERROR: APK not found at $APK_PATH!\"

            \  exit 1

            fi"
    - firebase-app-distribution@0:
        title: Deploy to Firebase App Distribution
        inputs:
        - app_path: $ANDROID_APK_PATH
        - firebase_token: $FIREBASE_TOKEN
        - app: $FIREBASE_APP_ID_ANDROID
        - groups: test
        - release_notes: |
            Tracker Costs - Expense Tracker App
            
            Build Information:
            - Version: 1.0.0+$BITRISE_BUILD_NUMBER
            - Branch: $BITRISE_GIT_BRANCH
            - Commit: $GIT_CLONE_COMMIT_HASH
            - Platform: Android
            
            Features:
            - Firebase Firestore integration
            - Real-time expense tracking  
            - User authentication (Email/Google)
            - Monthly budget management
            - Category-based expenses
            
            Test Checklist:
            ✓ Login/Register functionality
            ✓ Add/Edit/Delete expenses
            ✓ Real-time data synchronization
            ✓ Budget tracking
            ✓ Category filtering
    - script@1:
        title: Generate Build Report
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e

            cat > "$BITRISE_DEPLOY_DIR/BUILD_REPORT.md" <<EOF
            # Tracker Costs - Build Report

            ## Build Information
            - Version: 1.0.0
            - Package: com.example.tracker_costs
            - Build: #$BITRISE_BUILD_NUMBER
            - Branch: $BITRISE_GIT_BRANCH
            - Commit: ${GIT_CLONE_COMMIT_HASH:0:7}
            - Date: $(date +'%Y-%m-%d %H:%M:%S')

            ## Firebase Services
            - Firestore Database: Enabled
            - Firebase Auth: Enabled
            - Firebase Analytics: Enabled
            - Firebase Crashlytics: Enabled
            - App Distribution: Deployed

            ## Features
            - User Authentication (Email/Password, Google)
            - Real-time Expense Tracking
            - Monthly Budget Management
            - Category-based Filtering

            ## Testing Checklist
            - [ ] Login/Register
            - [ ] Add/Edit/Delete expenses
            - [ ] Real-time sync
            - [ ] Budget calculations
            - [ ] Category filtering
            EOF

            echo "Build report created"
    - script@1:
        title: Create Installation Instructions
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e

            cat > "$BITRISE_DEPLOY_DIR/INSTALL_INSTRUCTIONS.txt" <<'EOF'
            ============================================================
            Tracker Costs - Installation Guide
            ============================================================

            METHOD 1: Firebase App Distribution (RECOMMENDED)
            1. Check email for Firebase invitation
            2. Install Firebase App Tester from Play Store
            3. Open invitation link and download app

            METHOD 2: Manual APK Installation
            1. Download APK to Android device
            2. Enable: Settings > Security > Unknown Sources
            3. Open APK file and install

            METHOD 3: ADB Installation (Developers)
            1. Enable USB Debugging on device
            2. Connect device to computer
            3. Run: adb install TrackerCosts_v1.0.0.apk

            TROUBLESHOOTING:
            - "App not installed": Uninstall old version first
            - "Can't login": Check internet connection
            - "Data not syncing": Logout and login again

            For support, contact the development team.
            ============================================================
            EOF

            echo "Installation instructions created"
    - deploy-to-bitrise-io@2:
        inputs:
        - notify_user_groups: everyone
        - is_compress: 'false'
meta:
  bitrise.io:
    stack: linux-docker-android-22.04
