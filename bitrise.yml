---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: flutter

# Trigger Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ
triggers:
  push:
    - branch: main
      workflow: android_firebase
  pull_request:
    - source_branch: "*"
      workflow: android_firebase

# Workflows
workflows:
  
  android_firebase:
    description: Build Android APK Ğ´Ğ»Ñ Tracker Costs Ğ· Firebase App Distribution
    steps:
    
    # 1. ĞĞºÑ‚Ğ¸Ğ²ÑƒĞ²Ğ°Ñ‚Ğ¸ SSH key Ğ´Ğ»Ñ Git
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    
    # 2. ĞšĞ»Ğ¾Ğ½ÑƒĞ²Ğ°Ñ‚Ğ¸ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ñ–Ğ¹
    - git-clone@8: {}
    
    # 3. Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Flutter
    - flutter-installer@0:
        inputs:
        - version: 3.24.5
        - is_update: 'false'
    
    # 4. Cache Dart packages
    - restore-dart-cache@2: {}
    
    # 5. Flutter pub get
    - script@1:
        title: Flutter packages get
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            echo "ğŸ“¦ Installing Flutter dependencies..."
            flutter pub get
            echo "âœ… Dependencies installed"
    
    # 6. Flutter analyze (Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° ĞºĞ¾Ğ´Ñƒ)
    - script@1:
        title: Flutter analyze
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            echo "ğŸ” Running Flutter analyze..."
            flutter analyze || true
        is_always_run: false
    
    # 7. Run tests (Ğ¾Ğ¿Ñ†Ñ–Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
    - script@1:
        title: Run Flutter tests
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            echo "ğŸ§ª Running tests..."
            flutter test || echo "âš ï¸ No tests found or tests failed"
        is_always_run: false
    
    # 8. Save Dart cache
    - save-dart-cache@1: {}
    
    # 9. Decode Firebase google-services.json (ÑĞºÑ‰Ğ¾ Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ² Secrets)
    - script@1:
        title: Setup Firebase Configuration
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ğŸ”¥ Setting up Firebase configuration..."
            
            # Ğ¯ĞºÑ‰Ğ¾ google-services.json Ğ·Ğ°ĞºĞ¾Ğ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ² base64 Ğ² Secrets
            if [ ! -z "$GOOGLE_SERVICES_JSON_BASE64" ]; then
                echo "Decoding google-services.json from Secrets..."
                echo "$GOOGLE_SERVICES_JSON_BASE64" | base64 -d > android/app/google-services.json
                echo "âœ… google-services.json created from Secrets"
            else
                echo "âš ï¸ Using google-services.json from repository"
            fi
            
            # Verify file exists
            if [ -f "android/app/google-services.json" ]; then
                echo "âœ… google-services.json found"
            else
                echo "âŒ google-services.json NOT found!"
                exit 1
            fi
        is_always_run: true
    
    # 10. Build Android APK (release)
    - script@1:
        title: Build Android APK (Release)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ğŸ”¨ Building Tracker Costs Android APK in RELEASE mode..."
            flutter build apk --release --no-tree-shake-icons
            
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
            
            if [ -f "$APK_PATH" ]; then
                echo "âœ… APK built successfully!"
                echo "ğŸ“¦ APK info:"
                ls -lh "$APK_PATH"
                
                # Get APK size
                APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
                echo "Size: $APK_SIZE"
                
                # Export Ğ´Ğ»Ñ Firebase
                envman add --key ANDROID_APK_PATH --value "$BITRISE_SOURCE_DIR/$APK_PATH"
                
                # Copy to deploy dir with version
                BUILD_NAME="TrackerCosts_v1.0.0_build${BITRISE_BUILD_NUMBER}.apk"
                cp "$APK_PATH" "$BITRISE_DEPLOY_DIR/$BUILD_NAME"
                echo "âœ… APK copied to artifacts as: $BUILD_NAME"
            else
                echo "âŒ APK not found at $APK_PATH!"
                exit 1
            fi
    
    # 11. Verify Firebase configuration
    - script@1:
        title: Verify Firebase App ID
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ğŸ” Checking Firebase App Distribution configuration..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "App ID: ${FIREBASE_APP_ID_ANDROID:0:20}..."
            echo "APK Path: $ANDROID_APK_PATH"
            echo "Build Number: $BITRISE_BUILD_NUMBER"
            echo "Branch: $BITRISE_GIT_BRANCH"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Validate Firebase App ID
            if [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
                echo "âŒ FIREBASE_APP_ID_ANDROID is not set!"
                echo "Please add it in Bitrise Secrets:"
                echo "1. Go to Bitrise > Workflow Editor > Secrets"
                echo "2. Add: FIREBASE_APP_ID_ANDROID = 1:98211696497:android:6829066851715285e630d0"
                exit 1
            fi
            
            # Validate Firebase Token
            if [ -z "$FIREBASE_TOKEN" ]; then
                echo "âŒ FIREBASE_TOKEN is not set!"
                echo "Generate token: firebase login:ci"
                exit 1
            fi
            
            # Validate APK
            if [ ! -f "$ANDROID_APK_PATH" ]; then
                echo "âŒ APK file not found at $ANDROID_APK_PATH"
                exit 1
            fi
            
            echo "âœ… All Firebase configurations are valid"
    
    # 12. Firebase App Distribution (Android)
    - script@1:
        title: Deploy to Firebase App Distribution
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            
            echo "ğŸ”¥ Deploying Tracker Costs to Firebase App Distribution..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“± APK: $ANDROID_APK_PATH"
            echo "ğŸ†” App ID: 1:98211696497:android:6829066851715285e630d0"
            echo "ğŸŒ¿ Branch: $BITRISE_GIT_BRANCH"
            echo "ğŸ”¢ Build: #$BITRISE_BUILD_NUMBER"
            echo "ğŸ“ Commit: ${GIT_CLONE_COMMIT_HASH:0:7}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Verify APK exists
            if [ ! -f "$ANDROID_APK_PATH" ]; then
                echo "âŒ APK file not found!"
                exit 1
            fi
            
            # Install Firebase CLI
            echo "ğŸ“¥ Installing Firebase CLI..."
            npm install -g firebase-tools
            
            # Check Firebase CLI version
            firebase --version
            
            # Prepare release notes
            RELEASE_NOTES="ğŸ¯ Tracker Costs - Expense Tracker App
            
ğŸ“¦ Build Information:
â€¢ Version: 1.0.0
â€¢ Build Number: #$BITRISE_BUILD_NUMBER
â€¢ Branch: $BITRISE_GIT_BRANCH
â€¢ Commit: ${GIT_CLONE_COMMIT_HASH:0:7}
â€¢ Built: $(date +'%Y-%m-%d %H:%M:%S')

âœ¨ Features:
â€¢ Firebase Firestore integration
â€¢ Real-time expense tracking
â€¢ User authentication (Email/Google)
â€¢ Monthly budget management
â€¢ Category-based expenses
â€¢ Analytics & Crashlytics

ğŸ”§ Firebase Services:
â€¢ Firestore Database âœ…
â€¢ Firebase Auth âœ…
â€¢ Firebase Analytics âœ…
â€¢ Firebase Crashlytics âœ…

ğŸ“± Installation:
1. Download from Firebase App Distribution
2. Enable 'Unknown Sources' on Android
3. Install APK
4. Login with your account

âš ï¸ Test the following:
â€¢ Login/Register functionality
â€¢ Add/Edit/Delete expenses
â€¢ Real-time data sync
â€¢ Budget tracking
â€¢ Category filtering"
            
            # Upload to Firebase App Distribution
            echo "ğŸš€ Starting upload to Firebase..."
            firebase appdistribution:distribute "$ANDROID_APK_PATH" \
              --app "$FIREBASE_APP_ID_ANDROID" \
              --token "$FIREBASE_TOKEN" \
              --groups "testers" \
              --release-notes "$RELEASE_NOTES" \
              --debug
            
            EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ]; then
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âœ… Successfully deployed to Firebase App Distribution!"
                echo "ğŸ“§ Testers in 'testers' group will receive email notification"
                echo "ğŸ”— Check Firebase Console for distribution status"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            else
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âŒ Firebase upload failed with exit code: $EXIT_CODE"
                echo "ğŸ” Troubleshooting:"
                echo "1. Verify FIREBASE_TOKEN is valid (run: firebase login:ci)"
                echo "2. Check FIREBASE_APP_ID_ANDROID matches your app"
                echo "3. Ensure 'testers' group exists in Firebase Console"
                echo "4. Check Firebase Console > App Distribution for errors"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit $EXIT_CODE
            fi
    
    # 13. Generate Build Report
    - script@1:
        title: Generate Build Report
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ğŸ“Š Generating build report..."
            
            cat > $BITRISE_DEPLOY_DIR/BUILD_REPORT.md << EOF
            # ğŸ¯ Tracker Costs - Build Report
            
            ## ğŸ“¦ Build Information
            
            | Property | Value |
            |----------|-------|
            | **App Name** | Tracker Costs |
            | **Version** | 1.0.0 |
            | **Build Number** | #$BITRISE_BUILD_NUMBER |
            | **Branch** | $BITRISE_GIT_BRANCH |
            | **Commit** | ${GIT_CLONE_COMMIT_HASH:0:7} |
            | **Built On** | $(date +'%Y-%m-%d %H:%M:%S') |
            | **Flutter Version** | $(flutter --version | head -n 1) |
            
            ## ğŸ”¥ Firebase Configuration
            
            | Service | Status |
            |---------|--------|
            | **Firestore Database** | âœ… Enabled |
            | **Firebase Auth** | âœ… Enabled |
            | **Firebase Analytics** | âœ… Enabled |
            | **Firebase Crashlytics** | âœ… Enabled |
            | **App Distribution** | âœ… Deployed |
            
            ## ğŸ“± App Details
            
            - **Package**: com.example.tracker_costs
            - **Firebase Project**: tracker-costs
            - **App ID**: 1:98211696497:android:6829066851715285e630d0
            
            ## âœ¨ Features
            
            - âœ… User Authentication (Email/Password, Google Sign-In)
            - âœ… Real-time Expense Tracking with Firestore
            - âœ… Monthly Budget Management
            - âœ… Category-based Expense Filtering
            - âœ… User Settings & Preferences
            - âœ… Composite Firestore Indexes
            - âœ… Security Rules Implementation
            
            ## ğŸ“Š Technical Stack
            
            - **Framework**: Flutter 3.24.5
            - **State Management**: Provider
            - **Database**: Cloud Firestore
            - **Authentication**: Firebase Auth
            - **Analytics**: Firebase Analytics
            - **Crash Reporting**: Firebase Crashlytics
            
            ## ğŸ§ª Testing Checklist
            
            - [ ] Login with Email/Password
            - [ ] Login with Google
            - [ ] Add new expense
            - [ ] Edit existing expense
            - [ ] Delete expense
            - [ ] Check real-time sync
            - [ ] Verify budget calculations
            - [ ] Test category filtering
            - [ ] Check user settings
            - [ ] Verify data persists after logout
            
            ## ğŸ“¥ Installation
            
            ### Option 1: Firebase App Distribution
            1. Check your email for Firebase invitation
            2. Install Firebase App Tester app
            3. Download and install the build
            
            ### Option 2: Direct APK Install
            1. Download APK from Bitrise artifacts
            2. Enable "Install from Unknown Sources"
            3. Install APK on Android device
            
            ### Option 3: ADB Install
            \`\`\`bash
            adb install TrackerCosts_v1.0.0_build${BITRISE_BUILD_NUMBER}.apk
            \`\`\`
            
            ## ğŸ”— Useful Links
            
            - [Firebase Console](https://console.firebase.google.com/project/tracker-costs)
            - [App Distribution](https://console.firebase.google.com/project/tracker-costs/appdistribution)
            - [Firestore Database](https://console.firebase.google.com/project/tracker-costs/firestore)
            - [Bitrise Build](https://app.bitrise.io/build/${BITRISE_BUILD_SLUG})
            
            ## ğŸ“ Release Notes
            
            See Firebase App Distribution for detailed release notes sent to testers.
            
            ---
            
            **Built with â¤ï¸ by Bitrise CI/CD**
            EOF
            
            echo "âœ… Build report created: BUILD_REPORT.md"
    
    # 14. Create Installation Instructions
    - script@1:
        title: Create Installation Instructions
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cat > $BITRISE_DEPLOY_DIR/INSTALL_INSTRUCTIONS.txt << 'EOF'
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘        ğŸ¯ Tracker Costs - Installation Instructions           â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            ğŸ“¦ APK File: TrackerCosts_v1.0.0_buildXX.apk
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“± METHOD 1: Firebase App Distribution (RECOMMENDED)
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            1. Check your email for Firebase App Distribution invitation
            2. Install "Firebase App Tester" from Google Play Store
            3. Open the invitation link from email
            4. Tap "Download" in Firebase App Tester
            5. Install the app and start testing!
            
            âœ… Benefits:
            â€¢ Automatic updates when new builds are available
            â€¢ Easy to manage versions
            â€¢ Crash reports automatically sent to developers
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“± METHOD 2: Manual APK Installation
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            1. Download the APK file to your Android device
            
            2. Enable "Unknown Sources" on your Android:
               â€¢ Android 8.0+: Settings > Apps > Special Access > 
                 Install Unknown Apps > Select your browser/File Manager
               â€¢ Older Android: Settings > Security > Unknown Sources (toggle ON)
            
            3. Open the downloaded APK file
            
            4. Tap "Install"
            
            5. Wait for installation to complete
            
            6. Tap "Open" to launch the app
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ’» METHOD 3: ADB Installation (Developers)
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            1. Enable USB Debugging on your Android device:
               Settings > About Phone > Tap "Build Number" 7 times
               Settings > Developer Options > USB Debugging (toggle ON)
            
            2. Connect device to computer via USB
            
            3. Run in terminal:
               adb install TrackerCosts_v1.0.0_buildXX.apk
            
            4. For emulator:
               adb -e install TrackerCosts_v1.0.0_buildXX.apk
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ” First Launch
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            After installing the app:
            
            1. Open "Tracker Costs" app
            2. Create account with Email/Password OR Login with Google
            3. Grant necessary permissions if prompted
            4. Start tracking your expenses!
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âœ¨ App Features
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            â€¢ Real-time expense tracking with Firebase Firestore
            â€¢ Monthly budget management
            â€¢ Category-based expense organization
            â€¢ User authentication (Email/Google Sign-In)
            â€¢ Automatic data sync across devices
            â€¢ Analytics and crash reporting
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âš ï¸ Troubleshooting
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            âŒ "App not installed" error:
            â†’ Uninstall previous version first
            â†’ Enable "Unknown Sources"
            â†’ Check if you have enough storage
            
            âŒ Can't login:
            â†’ Check internet connection
            â†’ Verify email/password are correct
            â†’ For Google Sign-In: ensure Google Play Services are updated
            
            âŒ Data not syncing:
            â†’ Check internet connection
            â†’ Logout and login again
            â†’ Clear app cache: Settings > Apps > Tracker Costs > Clear Cache
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            âœ… Installation Complete!
            
            For support or bug reports, contact the development team.
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            EOF
            
            echo "âœ… Installation instructions created"
    
    # 15. Deploy Ğ²ÑÑ–Ñ… Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ–Ğ² Ğ´Ğ¾ Bitrise
    - deploy-to-bitrise-io@2:
        inputs:
        - notify_user_groups: none
        - is_compress: 'false'

# App environment variables
app:
  envs:
  - BITRISE_FLUTTER_PROJECT_LOCATION: "."
    opts:
      is_expand: false
  - FLUTTER_VERSION: stable
    opts:
      is_expand: false
  - BITRISE_PROJECT_PATH: android/build.gradle.kts
    opts:
      is_expand: false

# Bitrise Stack
meta:
  bitrise.io:
    stack: linux-docker-android-22.04
    machine_type_id: standard
